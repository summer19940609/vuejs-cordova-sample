<template>
    <v-container class="setting-container">
        <svg v-show="formShow" xmlns="http://www.w3.org/2000/svg" class="nga-icon" viewBox="129.22 30.208 1120.58 411.795">
            <path
                fill-rule="evenodd"
                d="M1192.47 335.038L1165.6 219.78l-8.62-2.889 7.7 118.147h-59V82.75l5.75-5.853 46.75-5.5L1188.6 189.6l8.78 2.567L1189.93 83l3.33-5.884 56.54-5.449v263.371h-57.33zm-234.661-.538l-10.352-8.734-9.16-57.937.053-11.09 9.291-167.1 9.631-9.9 92.158-13.713 28.49 34.508 5.5 40.053v30.233h-53.2l-11.51-55.48-17.86 3.149-5.1 149.449 5.1 23.035 22.05-3.722 6.73-52.221 53.79.011v73l-19.46 26.438zM898.5 288.715h34.044V335H898.5v-46.285zm-75.236-.39h-25.438l-4.276 46.713h-62.614l30.132-248.484 10.408-9.636 81.144-9.271 36.232 267.391h-61.771zm-10.229-158.973L807.128 133 796.92 242.254h24.48zM669.371 316.417l-16.115 18.059-64.447.019-10.352-8.734-9.16-57.937.053-11.09 9.291-167.1 9.631-9.9 92.156-13.713 28.5 34.508 5.491 40.053v30.238h-53.2l-11.5-55.48-17.861 3.149-5.1 149.449 5.1 23.035 22.047-3.722 3.07-21.4 3.667-30.821h-19.488v-39.489h73.261v139.5H675.15zm-122.9 18.621h-57.337L462.271 219.78l-8.629-2.889 7.7 118.147h-58.993V82.75l5.751-5.85 46.75-5.5 30.414 118.2 8.787 2.567L486.593 83l3.336-5.884 62.208-7.468L546.47 101v234.038zm-142.462 30.815h-13.692v6.678h-11.5v-6.678H359.4v6.678h-11.3v-6.678h-14.093v-8.071H348.1v-6.795h11.3v6.795h19.408v-6.795h11.5v6.795H404v8.071zm-234.822-79.74l-39.967-2.864V30.208h225.066l-3.241 45.227 27.772 1.99v257.637H165.681zm29.651-207.861l-11.5 3.113-10.947 19.082 17.7 12.294 18.836-5.649.721-2.125-2.778-23.806 3.658-26.774zm44.005 3.472l-10.358 17.594 5.886 19.985 8.53-4.207 8.773-3.079 4.846-23.094L264.7 51.8zm41.569 6.755L269.1 112.263l4.08 15.258 18.785-4.063 3.972-16.213 2.875-14.007 3.659-26.774zm32.2 19.806l-15.772 23.489 4.1 11.71 15.617-4.165 9.09-21.65 5.375-27.933zm37.24 34.067l-.822-9.27 1.881-14.973-13.04 19.749-13.62 3.757 5.87 16.816 14.175.083zM261.48 302.875l27.273 10.638 19.234-35.658-12.241-31.208-50.99-7.719-2.656 34.283zm-58.357-137.367l31.5 1.976 68.321 52.41 12.569 3.58 20.868-11.174-2.187-24.364-76.618-50.41-71.294-8.139-34.841 33.519-3.041 27.824s11.908 24.2 20.466 36.516c11.464.276 40.155 1.029 40.155 1.029l-11.2-54.534zm-31.088 190.144l2.528 18.455-6.16-.328L166.2 356.4zm17.6 18.455l2.92-18.455 4.43.743-3.28 17.712h-4.07zm-22.264 16.526v-8.926h9.51v-30.674h9.846v30.654h8.295v8.925h-8.445l11.585 24.528-4.428 6.715-2.972-7.967-3.631-8.1-.383 36.212h-9.883v-.02l.219-36.193-4.218 11.253-4.146 10.139-5.72-8.493 13.676-28.053h-9.306zm48.164-12.764h-12.589v-5.7h12.591v-8.023h-13.413v-6.463h13.413v-6.653h11.284v6.653h13.416v6.463h-13.416v8.023H239.3v5.7h-12.479v8.242h15.246v7.3h-40.86v-7.3h14.33v-8.242zm23.765 64.093h-9.744l1.019-2.1V429.1h-18.904v12.865h-8.725v-41.524H239.3v41.521zm-20.7-34.279h-6.931v14.663h6.931v-14.663zm11.975 0h-6.725v14.663h6.725v-14.663zm-1.028 34.279h.009l-.009.018v-.018zm112.912-58.531H362.9v-8.48h12.4v8.48h20.436v20.362h7.352v9.35h-22.676l3.2 3.638a83.019 83.019 0 0 0 19.446 16.241l-7.2 8.964a102.793 102.793 0 0 1-24.7-23.443l-1.581-2.09-1.856 1.741c-2.756 3.544-12.461 15.428-25.067 23.792l-7.316-9.022a88.52 88.52 0 0 0 19.352-16.183l3.27-3.638h-23.053v-9.35h7.554v-20.362zm32.841 20.362h10.75V391.1H375.3v12.7zm-23.158 0H362.9V391.1h-10.756v12.7zm154.719-9.99h-6.031v-11.515h6.031v-18.44h-6.776v-11.717H525.5v11.739h-6.224v18.44h5.262v11.512h-5.262v22l7.854-.556v11.944l-28.869 2.058V417.3l8.6-.575V393.8zM572.519 351v11.164h-37.257V351h37.257zm5.048 36.737h-7.426V430.5h8.23l.924-.761v11.245h-21v-53.267h-8.329l-3.634 54.254-11.782-.721 3.555-53.514h-6.933V376.8h46.39v10.934zm120.066-36.749h14.28v7.472h28.62v20.007h-10.527V367h-50.464v11.464h-10.529v-20.005h28.62v-7.472zm4.76 56.974l-.342-3.379-28.037 16.129-4.174-6.221 31.019-16.937-1.753-6.97-24.326 13.1-4.193-6.758 23.536-11.792-1.048-4.05h-5.931v-6.761h35.276v6.761h-14.1l1.372 2.993a79.408 79.408 0 0 1 3.427 9.237l.906 2.88 16.319-11.232 5.83 7.641-16.923 11.139L741 428.468l-8.187 7.144-16.665-20.512-.564 5.377a64.2 64.2 0 0 1-6.294 21.526l-13.471-2.8.381-.212.283-.673a76.951 76.951 0 0 0 3.974-11.348l1.271-5.069-26.885 15.975-4.741-6.7 32.413-18.3v-1.228a34.229 34.229 0 0 0-.122-3.687zm158.148-54.115l-5.289 11.553v75.63H844.87L845 387l-4.024 9.42-2.476 5.38-6.816-8.076 20.046-42.668zm6.174 1.359h36.763v56.57h6.136v9.163h-48.135v-9.163h5.236v-56.57zm10.088 56.57h16.479v-7.959H876.8v7.959zm0-13.823h16.479V389.9H876.8v8.056zm0-13.3h16.479V376.7H876.8v7.959zm0-13.609h16.479v-8.056H876.8v8.056zm4.352 59.775l-11.849 11.161-6.705-7.454 12.05-11.065zm29.581 3.727l-6.56 7.434-11.924-11.16 6.394-7.358zm113.7-18.671l-15.67 21.9-7.5-7.324 15.66-21zm6.89-13.681h-28.57v-10.31h5.93v-35.441L1061.64 351l1.16 9.087-42.62 4.439v27.362h11.14v-20.58h13.82v20.58h26.28V402.2h-26.28V442h-16.42l2.61-3.313V402.2zm44.2 28.233l-7.59 7.324-15.58-21.779 7.51-6.434zm98.44-61.071h-3.86v-8.624h13.53v-9.684h11.27v9.684h14.16v8.624h-4.68v17.619h5.72v9.606h-42.18v-9.606h6.04v-17.618zm9.81 17.619h11.02v-17.618h-11.02v17.619zM1207.51 442h-35.63v-35.2h35.63V442zm-10.22-25.3h-14.86v15.694h14.86V416.7zm42.26-26.851l.46.748a46.807 46.807 0 0 1 6.55 23.472c0 10.293-4.02 21.372-12.86 21.372h-7.22v6.459h-10.25V353H1247zm-13.11-26.616v24.79h.02l4.2.413 4.64-25.2h-8.86zm4.01 28.9l-3.99 1.061v30.6h2.94c3.96 0 6.5-4.576 6.5-11.667 0-5.841-2.18-13.876-5.45-20.003z"
                data-name="Color Fill 5"
            ></path>
        </svg>
        <van-form @submit="onSubmit" class="login-form" v-show="formShow">
            <van-field v-model="username" name="username" label="用户名" placeholder="用户名" :rules="[{ required: true, message: '请填写用户名' }]" />
            <van-field v-model="password" type="password" name="password" label="密码" placeholder="密码" :rules="[{ required: true, message: '请填写密码' }]" />
            <div style="margin: 16px 0;">
                <van-button block type="info" native-type="submit" class="nga-gray">下一步</van-button>
            </div>
        </van-form>

        <div class="auth-code-box" v-show="codeShow">
            <img :src="codePic" alt="" class="auth-code-img" />
            <van-cell-group class="input-cell">
                <van-field v-model="authCode" label="验证码" placeholder="请输入验证码" />
            </van-cell-group>
            <van-button type="info" block @click="login" class="nga-gray" :disabled="loginLoading" :loading="loginLoading">登录</van-button>
            <van-button type="info" block @click="refreshCode" class="btn-refresh-code nga-gray">换一个验证码</van-button>
        </div>
    </v-container>
</template>

<script>
import dayjs from 'dayjs'
import CRC32 from 'crc32'
import md5 from 'md5'
export default {
    name: 'setting',
    data() {
        return {
            username: '',
            password: '',
            authCode: '',
            authCodeCookie: '',
            codePic: '',
            codeShow: false,
            formShow: true,
            loginLoading: false
        }
    },
    mounted() {
        this.$store.commit('setTitle', 'NGA登录')
    },
    methods: {
        onSubmit() {
            this.formShow = false
            this.loadAuthCode()
        },
        getNgaClientChecksum() {
            const secret = '3ebd769858c56bd345898154e4b44427'
            const currTime = dayjs().unix()
            const crc32 = CRC32('xnj19940609')
            const str = `${crc32}${secret}${currTime}`
            const ngaClientChecksum = `${md5(str)}${currTime}`
            return ngaClientChecksum
        },
        loadAuthCode() {
            const authCookie = '_' + Math.random()
            this.authCodeCookie = authCookie
            const url = `https://bbs.nga.cn/login_check_code.php?id=${authCookie}`
            const options = {
                method: 'get',
                responseType: 'blob',
                headers: {
                    Referer: 'https://bbs.nga.cn/nuke/account_copy.html?login'
                }
            }
            this.$store.commit('showLoading')
            this.$nativeHttp.curl(url, options).then(
                data => {
                    this.blobToBase64(data)
                        .then(res => {
                            this.$store.commit('hideLoading')
                            this.codeShow = true
                            this.codePic = res
                        })
                        .catch(err => {
                            this.$store.commit('hideLoading')
                            this.$toast.fail(JSON.stringify(err))
                        })
                },
                () => {
                    this.$store.commit('hideLoading')
                }
            )
        },
        login() {
            this.loginLoading = true
            const params = {
                name: this.username,
                type: 'name',
                password: this.password,
                rid: this.authCodeCookie,
                captcha: this.authCode.toUpperCase(),
                __lib: 'login',
                __act: 'login',
                __output: 11,
                __inchst: 'UTF-8',
                raw: 3,
                qrkey: ''
            }
            console.log(`==== [params] => ${JSON.stringify(params)}`)
            this.$nativeHttp.setDataSerializer('multipart')
            const formData = this.$nativeHttp.createFormData(params)
            const loginOptions = {
                method: 'post',
                data: formData,
                responseType: 'json',
                headers: {
                    Referer: 'https://bbs.nga.cn/nuke/account_copy.html?login',
                    'Content-Type': 'multipart/form-data;'
                }
            }
            this.$store.commit('showLoading')
            this.$nativeHttp.curl(`https://bbs.nga.cn/nuke.php`, loginOptions).then(
                res => {
                    this.$store.commit('hideLoading')
                    this.loginLoading = false
                    const data = res.data
                    const error = res.error
                    if (error) {
                        this.$toast.fail(JSON.stringify(error))
                        return
                    }
                    if (data[0] === '登录成功') {
                        const ngaPassportUid = data[1]
                        const ngaPassportCid = data[2]
                        const cookie = {
                            ngaPassportUid,
                            ngaPassportCid
                        }
                        const userInfo = data[3]
                        console.log(`==== [userInfo] => ${JSON.stringify(userInfo)}`)
                        localStorage.setItem('ngaCookie', JSON.stringify(cookie))
                        localStorage.setItem('userInfo', JSON.stringify(userInfo))
                        this.$store.commit('setUserInfo', userInfo)
                        this.$toast.success('登录成功')
                        this.$router.push('/profile')
                    }
                },
                err => {
                    this.$store.commit('hideLoading')
                    this.$toast.fail(JSON.stringify(err))
                    this.loginLoading = false
                }
            )
        },
        refreshCode() {
            this.loadAuthCode()
        },
        // blob => base64
        blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const fileReader = new FileReader()
                fileReader.onload = e => {
                    resolve(e.target.result)
                }
                // readAsDataURL
                fileReader.readAsDataURL(blob)
                fileReader.onerror = () => {
                    reject(new Error('blobToBase64 error'))
                }
            })
        }
        // ngaLogin() {
        //     const ngaHeader = {
        //         'User-Agent': 'Mozilla/5.0 (Windows NT 6.3; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/36.0.1985.125 Safari/537.36 AndroidNGAOS/',
        //         Host: 'bbs.nga.cn',
        //         Connection: 'keep-alive',
        //         'Cache-Control': 'max-age=0',
        //         'Accept-Language': 'zh-CN,zhq=0.9,enq=0.8',
        //         'Accept-Encoding': 'gzip, deflate, br',
        //         Accept: 'text/html,application/xhtml+xml,application/xmlq=0.9,image/avif,image/webp,image/apng,*/*q=0.8,application/signed-exchangev=b3q=0.9'
        //     }
        //     const params = {
        //         __lib: 'login',
        //         __act: 'login',
        //         name: 'verygoodbye',
        //         password: 'xnj19940609',
        //         type: 'id',
        //         __output: '11',
        //         __inchst: 'GBK',
        //         __ngaClientChecksum: this.getNgaClientChecksum()
        //     }
        //     const options = {
        //         method: 'post',
        //         data: params,
        //         headers: ngaHeader,
        //         responseType: 'json',
        //         timeout: 10
        //     }
        //     console.log(`====> params => ${JSON.stringify(params)}`)
        //     this.$nativeHttp.post('https://bbs.nga.cn/nuke.php', options).then(
        //         () => {},
        //         () => {}
        //     )
        // },
    }
}
</script>

<style scoped>
.auth-code-box {
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}
.setting-container {
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    align-items: center;
    background: rgb(255, 246, 223);
    color: rgb(89, 24, 4);
    height: 100%;
    padding: 10px;
}
.nga-gray {
    background: rgb(89, 24, 4);
    border: 0;
}
.nga-icon {
    width: 200px;
    margin-top: 20px;
}
.login-form {
    margin-top: 20px;
    width: 100%;
}
.auth-code-img {
    margin-top: 40px;
    width: 100%;
}
.input-cell {
    margin: 20px 0;
    width: 100%;
}
.btn-refresh-code {
    margin-top: 20px;
}
</style>
